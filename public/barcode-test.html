<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Barcode Debug</title>
  <style>
    :root { --fg:#111; --muted:#666; --accent:#0a7; --bad:#b00; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color: var(--fg);}
    h1 { margin: 0 0 12px; }
    .chip { font-weight: 700; }
    .yes { color: var(--accent); }
    .no { color: var(--bad); }
    .muted { color: var(--muted); }
    .row { margin: 8px 0; }
    button { padding: 10px 14px; margin-right: 10px; }
    #wrap { max-width: 780px; }
    #video, #canvas { width: 100%; max-width: 720px; background:#000; border-radius: 6px; }
    #canvas { display:none; }
    pre { background:#f6f6f6; padding:10px; border-radius:6px; overflow:auto; }
    #log { min-height: 28px; }
  </style>
</head>
<body>
  <div id="wrap">
    <h1>Barcode Debug</h1>

    <div class="row">getUserMedia: <span id="gum" class="chip muted">checking…</span></div>
    <div class="row">BarcodeDetector: <span id="bd" class="chip muted">checking…</span></div>
    <div class="row muted" id="formatsRow" style="display:none;">
      Supported formats: <span id="formats"></span>
    </div>

    <div class="row">
      <button id="start">Start camera</button>
      <button id="stop" disabled>Stop</button>
      <button id="snap" disabled>Snapshot</button>
    </div>

    <video id="video" playsinline muted></video>
    <canvas id="canvas" width="1280" height="720"></canvas>

    <h3>Detections</h3>
    <pre id="detections">None yet.</pre>

    <h3>Log</h3>
    <pre id="log"></pre>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (m) => { $('log').textContent = m + '\n' + $('log').textContent; };

    // Elements
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    // Feature checks
    const hasGUM = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    $('gum').textContent = hasGUM ? 'YES' : 'NO';
    $('gum').className = 'chip ' + (hasGUM ? 'yes' : 'no');

    let detector = null;
    (async () => {
      if ('BarcodeDetector' in window) {
        try {
          const fmts = await BarcodeDetector.getSupportedFormats?.() || [];
          $('formats').textContent = fmts.join(', ');
          $('formatsRow').style.display = 'block';
          detector = new BarcodeDetector({ formats: fmts.length ? fmts : undefined });
          $('bd').textContent = 'YES';
          $('bd').className = 'chip yes';
        } catch (e) {
          $('bd').textContent = 'NO (' + e.message + ')';
          $('bd').className = 'chip no';
        }
      } else {
        $('bd').textContent = 'NO';
        $('bd').className = 'chip no';
      }
      updateButtons();
    })();

    let stream = null;
    let rafId = null;
    let frame = 0;

    function updateButtons() {
      $('start').disabled = !!stream;
      $('stop').disabled = !stream;
      $('snap').disabled = !stream;
    }

    async function startCam() {
      if (!hasGUM) { log('getUserMedia not supported.'); return; }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 }, height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        log('Camera started.');
        updateButtons();
        startLoop();
      } catch (e) {
        log('Camera error: ' + e.name + ' - ' + e.message);
      }
    }

    function stopCam() {
      if (rafId) cancelAnimationFrame(rafId), rafId = null;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        log('Camera stopped.');
        updateButtons();
      }
    }

    async function decodeFromCanvas() {
      if (!detector) return { ok:false, reason:'No BarcodeDetector' };
      try {
        const codes = await detector.detect(canvas);
        if (codes && codes.length) {
          const summary = codes.map(b => ({ format: b.format, rawValue: b.rawValue }));
          $('detections').textContent = JSON.stringify(summary, null, 2);
          return { ok:true, count: codes.length };
        }
        return { ok:false, reason:'none' };
      } catch (e) {
        log('Detect error: ' + e);
        return { ok:false, reason:e.message };
      }
    }

    function startLoop() {
      const loop = async () => {
        rafId = requestAnimationFrame(loop);
        if (!video.videoWidth) return;
        // draw video frame to canvas
        const w = canvas.width, h = canvas.height;
        // Resize canvas to match stream once
        if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Throttle decode (every 6th frame)
        if (detector && (++frame % 6 === 0)) {
          const res = await decodeFromCanvas();
          if (res.ok) log('Live decode: ' + res.count + ' barcode(s).');
        }
      };
      loop();
    }

    $('start').onclick = startCam;
    $('stop').onclick = stopCam;

    $('snap').onclick = async () => {
      if (!video.videoWidth) return;
      // Ensure latest frame is on canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.style.display = 'block';
      const res = await decodeFromCanvas();
      if (res.ok) {
        log('Snapshot decode success.');
      } else {
        log('Snapshot decode: no barcode found.');
      }
    };

    // Clean up if user navigates away
    window.addEventListener('pagehide', stopCam);
  </script>
</body>
</html>
