<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Barcode Debug</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; padding:16px; }
      #video { width:100%; max-width:480px; background:#000; }
      #canvas { display:none; }
      #log { white-space:pre-wrap; color:#444; font-size:14px; }
      .ok { color: #0a0; } .bad { color:#c00; }
      button { padding:10px 14px; margin-right:8px; }
    </style>
    <!-- ZXing fallback (only used if BarcodeDetector is unavailable) -->
    <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  </head>
  <body>
    <h1>Barcode Debug</h1>

    <p>
      <strong>getUserMedia:</strong> <span id="gum">?</span><br>
      <strong>BarcodeDetector API:</strong> <span id="bd">?</span>
    </p>

    <p>
      <button id="start">Start camera</button>
      <button id="stop" disabled>Stop</button>
    </p>

    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>

    <h3>Detections</h3>
    <div id="detections">None yet.</div>

    <h3>Log</h3>
    <div id="log"></div>

    <script>
      const v = document.getElementById('video');
      const c = document.getElementById('canvas');
      const detections = document.getElementById('detections');
      const log = (m)=>{ document.getElementById('log').textContent = m; };
      const set = (id, ok)=>{ const el=document.getElementById(id); el.textContent = ok? 'YES' : 'NO'; el.className = ok? 'ok':'bad'; };

      let stream, anim, detector, usingZXing=false, zxingReader;

      // feature flags
      set('gum', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
      set('bd', 'BarcodeDetector' in window);

      async function startCam(){
        try {
          log('Requesting camera…');
          const constraints = { video: { facingMode:{ideal:'environment'} }, audio:false };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          v.srcObject = stream;
          await v.play();
          document.getElementById('start').disabled = true;
          document.getElementById('stop').disabled  = false;
          log('✅ Camera started');

          if ('BarcodeDetector' in window) {
            detector = new BarcodeDetector({ formats: ['code_128','ean_13','upc_e','ean_8','qr_code','codabar','itf','data_matrix','pdf417','aztec'] });
            usingZXing = false;
            loopNative();
          } else {
            usingZXing = true;
            zxingReader = new ZXing.BrowserMultiFormatReader();
            loopZXing();
          }
        } catch (e) {
          log('❌ getUserMedia error:\n' + e.name + ': ' + e.message);
        }
      }

      function stopCam(){
        cancelAnimationFrame(anim);
        if (zxingReader) { try { zxingReader.reset(); } catch(_){} }
        if (stream) stream.getTracks().forEach(t=>t.stop());
        v.srcObject = null; stream = null;
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled  = true;
        log('⏹️ Camera stopped');
      }

      function showDetections(list){
        if (!list || !list.length){ detections.textContent = 'None yet.'; return; }
        detections.innerHTML = list.map(d =>
          `<div><b>${d.format || d.rawValue ? (d.format||'') : ''}</b> ${d.rawValue || d.text}</div>`
        ).join('');
      }

      async function loopNative(){
        if (!stream) return;
        try {
          // draw current frame to canvas to avoid “not ready” size issues
          c.width = v.videoWidth || 640;
          c.height = v.videoHeight || 480;
          const ctx = c.getContext('2d');
          ctx.drawImage(v, 0, 0, c.width, c.height);
          const res = await detector.detect(c);
          showDetections(res.map(r=>({format:r.format, rawValue:r.rawValue})));
        } catch(e){ /* swallow decode errors */ }
        anim = requestAnimationFrame(loopNative);
      }

      async function loopZXing(){
        if (!stream) return;
        try {
          const result = await zxingReader.decodeOnceFromVideoElement(v);
          if (result) {
            showDetections([{ format: result.getBarcodeFormat(), text: result.getText() }]);
          }
        } catch(e){
          // decodeOnce throws on timeouts; keep trying
        }
        anim = requestAnimationFrame(loopZXing);
      }

      document.getElementById('start').onclick = startCam;
      document.getElementById('stop').onclick  = stopCam;
    </script>
  </body>
</html>
